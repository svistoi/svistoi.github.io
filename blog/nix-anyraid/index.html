<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src-attr 'unsafe-inline'">

    <title>Previewing ZFS Anyraid With nix | Igor’s Blog</title>

    <link rel="preload" href="https://blog.svistoun.com/fonts/FiraCode-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="https://blog.svistoun.com/fonts/FiraCode-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://blog.svistoun.com/css/style.css?h=fd30ebca55fd38ab02dd">
    <script src="https://blog.svistoun.com/js/auto-close-popover-on-resize.js?h=4ef87d6fc7b98b22e044" defer></script>
    <script src="https://blog.svistoun.com/js/copy-code-to-clipboard.js?h=6aac77c47d552a0ac847" defer></script>
    <script src="https://blog.svistoun.com/js/theme-switcher.js?h=5c008bd5655bc0304640" defer></script>

    <link rel="canonical" href="https://blog.svistoun.com/blog/nix-anyraid/">
    <link rel="alternate" type="application/rss+xml" href="https://blog.svistoun.com/rss.xml" title="Igor’s Blog">
    
    <meta name="author" content="Igor Svistoun">
    <meta name="description" content="Taking a look at new zfs anyraid vdev.">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#211f1a">
    <meta name="color-scheme" content="dark">

    <meta property="og:title" content="Previewing ZFS Anyraid With nix">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://blog.svistoun.com/blog/nix-anyraid/">
    <meta property="og:description" content="Taking a look at new zfs anyraid vdev.">
    <meta property="og:site_name" content="Igor’s Blog">
    <meta property="og:updated_time" content="2025-09-22T03:38:21.356107224+00:00">
    <meta property="article:published_time" content="2025-09-21T00:00:00+00:00">
    <meta property="article:tag" content="zfs">
    <meta property="article:tag" content="nix">
</head>

<body class="layout-center">
    <header class="header">
        <div class="header-container">
            <span class="header-logo-container">
                <a href="https://blog.svistoun.com">
                    <span class="logo">Igor’s Blog</span>
                </a>
            </span>
        </div>
        <nav class="main-menu" aria-label="Main Menu">
            <a class="skip-to-content" href="#main">Skip to main content</a>
            <button class="main-menu-dropdown-button" popovertarget="nav-menu">Menu</button>
            <ul id="nav-menu" class="main-menu-items" aria-label="Site Navigation" popover>
                <li><a href="https://blog.svistoun.com/blog/">blog</a></li>
                <li><a href="https://blog.svistoun.com/tags/">tags</a></li>
                <li><a href="https://blog.svistoun.com/rss.xml">rss</a></li>
            </ul>
        </nav>
    </header>
    <main id="main">
        <article class="post content">
            <header>
                <h1 class="post-title">
                    <a href="https://blog.svistoun.com/blog/nix-anyraid/">Previewing ZFS Anyraid With nix</a>
                </h1>
                <ul class="post-meta">
                    <li title="Published on 2025-09-21"><time datetime="2025-09-21">2025.09.21</time></li>
                    <li role="separator" aria-hidden="true">::</li>
                    <li title="257 words"><time datetime="PT2M">2 min</time> read</li>
                </ul>
                <div class="post-tags">
                    <span>#<a rel="tag" href="https://blog.svistoun.com/tags/zfs/">zfs</a></span>
                    <span>#<a rel="tag" href="https://blog.svistoun.com/tags/nix/">nix</a></span>
                </div>
            </header>

<p>Klara Systems is in the process of upstreaming a new ZFS vdev type.</p>
<blockquote>
<p>Anyraid allows devices of mismatched sizes to be combined together into a
single top-level vdev. In the current version, Anyraid only supports
mirror-type parity, but raidz-type parity is planned for the near future.
-- <cite><a href="https://github.com/openzfs/zfs/pull/17567">OpenZFS PR</a></cite></p>
</blockquote>
<p>This may take a while to merge and get released, but I'm excited to try this out.</p>
<h1 id="building-with-nix">Building With Nix<a class="post-anchor" href="#building-with-nix" aria-label="Anchor link for: building-with-nix"><span aria-hidden="true">#</span></a>
</h1>
<p>nixpkgs packages several versions of zfs in the following manner</p>
<pre data-lang="bash" style="background-color:#272822;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span>tree pkgs/os-specific/linux/zfs/
</span><span>pkgs/os-specific/linux/zfs/
</span><span>├── 2_2.nix
</span><span>├── 2_3.nix
</span><span>├── generic.nix
</span><span>└── unstable.nix
</span></code></pre>
<p>generic.nix provides a function to compile zfs, and 2_2.nix, 2_3.nix and unstable.nix call this function supplying the hash.</p>
<p>So I could just:</p>
<ul>
<li>modify generic.nix to accept github owner and repository as argument since it's hard-coded to openzfs project</li>
<li>fix the fact that master branch renamed arc_summary to zarcsummary</li>
<li>add anyraid.nix with customized parameters</li>
<li>add <code>zfs_anyraid</code> package wherever <code>zfs_unstable</code> is defined</li>
</ul>
<p>See <a href="https://github.com/NixOS/nixpkgs/compare/master...svistoi:nixpkgs:anyraid">diff</a></p>
<h1 id="nixos-integration-testing">NixOS Integration Testing<a class="post-anchor" href="#nixos-integration-testing" aria-label="Anchor link for: nixos-integration-testing"><span aria-hidden="true">#</span></a>
</h1>
<p>nixpkgs contains some zfs tests, though none for anyraid vdev.  However for sanity checking that it builds, I wanted to run the tests</p>
<pre data-lang="bash" style="background-color:#272822;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span>nix run .#nixosTests.zfs.anyraid.driver
</span></code></pre>
<h1 id="deploying-to-a-server">Deploying To A Server<a class="post-anchor" href="#deploying-to-a-server" aria-label="Anchor link for: deploying-to-a-server"><span aria-hidden="true">#</span></a>
</h1>
<p>I then configure my fork as flake input <code>nixpkgs-anyraid.url = "github:svistoi/nixpkgs/anyraid";</code> and build a server nixosConfigurations</p>
<p>with following options</p>
<pre data-lang="nix" style="background-color:#272822;color:#f8f8f2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="font-style:italic;color:#fd971f;">boot</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">kernelPackages </span><span style="background-color:#f92672;color:#f8f8f0;">=</span><span> </span><span style="font-style:italic;color:#fd971f;">lib</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">mkForce pkgs</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">linuxKernel</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">packages</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">linux_6_16</span><span style="background-color:#f92672;color:#f8f8f0;">;</span><span>
</span><span style="font-style:italic;color:#fd971f;">boot</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">zfs</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">package </span><span style="background-color:#f92672;color:#f8f8f0;">=</span><span> </span><span style="font-style:italic;color:#fd971f;">lib</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">mkForce pkgs</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">zfs_anyraid</span><span style="background-color:#f92672;color:#f8f8f0;">;</span><span>
</span><span style="font-style:italic;color:#fd971f;">boot</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">supportedFilesystems </span><span style="background-color:#f92672;color:#f8f8f0;">=</span><span> [</span><span style="color:#e6db74;">&quot;zfs&quot;</span><span>]</span><span style="background-color:#f92672;color:#f8f8f0;">;</span><span>
</span><span style="font-style:italic;color:#fd971f;">networking</span><span style="color:#f92672;">.</span><span style="font-style:italic;color:#fd971f;">hostId </span><span style="background-color:#f92672;color:#f8f8f0;">=</span><span> </span><span style="color:#e6db74;">&quot;67262970&quot;</span><span style="background-color:#f92672;color:#f8f8f0;">;</span><span>
</span></code></pre>
<p>The server configuration is out of scope of this.  I've learned a lot about about flake layouts from some notable repositories:</p>
<ul>
<li>https://github.com/MatthewCroughan/nixcfg</li>
<li>https://github.com/wimpysworld/nix-config</li>
<li>https://github.com/srid/nixos-config</li>
<li>https://github.com/jakehamilton/config</li>
</ul>
<h1 id="creating-a-pool-with-anyraid-vdev">Creating A Pool With Anyraid vdev<a class="post-anchor" href="#creating-a-pool-with-anyraid-vdev" aria-label="Anchor link for: creating-a-pool-with-anyraid-vdev"><span aria-hidden="true">#</span></a>
</h1>
<pre data-lang="bash" style="background-color:#272822;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span>zpool create</span><span style="font-style:italic;color:#fd971f;"> -f</span><span> tank anyraid </span><span style="color:#f92672;">&lt;</span><span>list of devices</span><span style="color:#f92672;">&gt;
</span></code></pre>

        </article>
    </main>
    <footer class="footer">
        <address class="socials">
            <ul>
                <li>
                    <a class="social-link" href="https://blog.svistoun.com/rss.xml" title="rss feed">
                        <svg role="img" aria-label="feed"><use aria-hidden="true" href="https://blog.svistoun.com/images/social_icons/rss.svg#icon" /></svg>
                    </a>
                </li>
                <li>
                    <a class="social-link" rel="me" href="https://github.com/svistoi" title="github">
                        <svg role="img" aria-label="github">
                            <use aria-hidden="true" href="https://blog.svistoun.com/images/social_icons/github.svg#icon" />
                        </svg>
                    </a>
                </li>
                <li>
                    <a class="social-link" rel="me" href="https://www.linkedin.com/in/igor-s-0248aba9/" title="linkedin">
                        <svg role="img" aria-label="linkedin">
                            <use aria-hidden="true" href="https://blog.svistoun.com/images/social_icons/linkedin.svg#icon" />
                        </svg>
                    </a>
                </li>
            </ul>
        </address>
        <p class="copyright">
            <span>© <time>2025</time> Igor Svistoun</span>
            <span>Powered by <a href="https://www.getzola.org">Zola</a></span>
            <span>Theme by <a href="https://eyalkalderon.com">ebkalderon</a></span>
        </p>
    </footer>
</body>

</html>
